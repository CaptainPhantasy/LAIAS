# =============================================================================
# LAIAS Agent Runner - Pre-Built Base Image
# =============================================================================
#
# This image is built ONCE and reused for ALL agent deployments.
# Generated agent code is mounted as volumes - NOT baked into the image.
#
# Build command:
#   docker build -f Dockerfile.agent-runner -t laias/agent-runner:latest .
#
# Usage (by Docker Orchestrator):
#   docker run -v /var/laias/agents/deploy_xyz:/app/agent:ro \
#              -e TASK_ID=task_123 \
#              -e OPENAI_API_KEY=sk-... \
#              laias/agent-runner:latest
#
# =============================================================================

# =============================================================================
# Stage 1: Builder - Compile and install dependencies
# =============================================================================
FROM python:3.11-slim AS builder

LABEL maintainer="LAIAS Platform"
LABEL description="Builder stage for agent runner"
LABEL stage="builder"

# Build-time dependencies
RUN apt-get update && apt-get install -y --no-install-recommends \
    build-essential \
    git \
    curl \
    && rm -rf /var/lib/apt/lists/* \
    && apt-get clean

# Create virtual environment
RUN python -m venv /opt/venv
ENV PATH="/opt/venv/bin:$PATH"

# Upgrade pip and install wheel for faster builds
RUN pip install --no-cache-dir --upgrade pip setuptools wheel

# Install all dependencies in a single layer for caching efficiency
RUN pip install --no-cache-dir \
    # CrewAI framework
    "crewai[tools]>=0.80.0" \
    # Data processing
    "pandas>=2.0.0" \
    "numpy>=1.24.0" \
    # API and web
    "fastapi>=0.109.0" \
    "uvicorn>=0.27.0" \
    "httpx>=0.26.0" \
    "aiohttp>=3.9.0" \
    "aiofiles>=23.0.0" \
    # Data validation
    "pydantic>=2.5.0" \
    "pydantic-settings>=2.1.0" \
    # Logging and monitoring
    "structlog>=24.0.0" \
    "python-json-logger>=2.0.0" \
    # Utilities
    "python-dotenv>=1.0.0" \
    "tenacity>=8.2.0" \
    "PyYAML>=6.0.0" \
    # Visualization (for data agents)
    "plotly>=5.18.0" \
    "matplotlib>=3.8.0" \
    # Web scraping tools
    "beautifulsoup4>=4.12.0" \
    "lxml>=5.0.0" \
    "selenium>=4.15.0" \
    # LLM providers
    "openai>=1.12.0" \
    "anthropic>=0.18.0"

# =============================================================================
# Stage 2: Runtime - Minimal production image
# =============================================================================
FROM python:3.11-slim AS runtime

LABEL maintainer="LAIAS Platform"
LABEL description="Pre-built agent runner with CrewAI and dependencies"
LABEL version="1.0"

# Install only runtime dependencies (no build tools)
RUN apt-get update && apt-get install -y --no-install-recommends \
    curl \
    && rm -rf /var/lib/apt/lists/* \
    && apt-get clean

# Copy virtual environment from builder stage
COPY --from=builder /opt/venv /opt/venv

# Set PATH to use venv
ENV PATH="/opt/venv/bin:$PATH"

# -----------------------------------------------------------------------------
# Directory Structure
# -----------------------------------------------------------------------------
# /app/agent/ is where generated code gets mounted
RUN mkdir -p /app/agent /app/outputs /app/logs

# -----------------------------------------------------------------------------
# Runtime Configuration
# -----------------------------------------------------------------------------
WORKDIR /app/agent

# Default environment variables (can be overridden at runtime)
ENV PYTHONUNBUFFERED=1
ENV PYTHONDONTWRITEBYTECODE=1
ENV LOG_LEVEL=INFO
ENV VERBOSE=true
ENV MEMORY_ENABLED=true

# -----------------------------------------------------------------------------
# Health Check
# -----------------------------------------------------------------------------
HEALTHCHECK --interval=30s --timeout=10s --start-period=5s --retries=3 \
    CMD python -c "import crewai; print('healthy')" || exit 1

# -----------------------------------------------------------------------------
# Entry Point
# -----------------------------------------------------------------------------
# Default: run flow.py that gets mounted at /app/agent/flow.py
CMD ["python", "flow.py"]
